name: Build

on:
  release:
    types:
      - created

  workflow_dispatch:
    inputs:
      version:
        description: "xxx.xxx.xxx"
        required: true

  permissions:
    contents: write

env:
  ARCH: x86_64
  TAG_NAME: |-
    ${{ github.event.release.tag_name || github.event.inputs.version }}

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v5
    - name: install depends
      run: |
        sudo apt update
        sudo apt install libgtk-4-dev build-essential libharfbuzz-dev libjpeg-dev libopenjp2-7-dev libjbig2dec0-dev libpng-dev libfreetype6-dev libarchive-dev libmupdf-dev libgumbo-dev libbrotli-dev liblcms2-dev libleptonica-dev libzxing-dev libtesseract-dev mold
    - name: cargo build release
      run: cargo build --release
    - name: get AppImageTool
      run: |
        wget -c https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x ./appimagetool-x86_64.AppImage
    - name: get linuxdeploy/linuxdeploy
      run: |
        wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x ./linuxdeploy-x86_64.AppImage
    - name: run linuxdeploy
      run: |
        ./linuxdeploy-x86_64.AppImage -e ./target/release/simple_comics_viewer -d ./for_appimage_assets/simple_comics_viewer.desktop -i ./for_appimage_assets/icon.svg --appdir ./appimage_dir
    - name: run AppImageTool
      run: |
        ./appimagetool-x86_64.AppImage ./appimage_dir
        rm -rf ./appimage_dir
    - uses: actions/upload-artifact@v4
      with:
        name: Simple_Comics_Viewer-x86_64.AppImage
        path: ./Simple_Comics_Viewer-x86_64.AppImage

  release:
    if: (github.event.release.tag_name || github.event.inputs.version) != ''
    needs: [build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: Simple_Comics_Viewer-x86_64.AppImage
          path: ./artifact
      - name: Upload AppImage to Release assets
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ github.event.inputs.prerelease }}
          files: ./artifact/Simple_Comics_Viewer-x86_64.AppImage
          tag_name: ${{ env.TAG_NAME }}
          target_commitish: ${{ github.sha }}
